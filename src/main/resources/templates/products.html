<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${category}">cat</title>
</head>
<body>
    <div th:insert="~{header :: header}"></div>
    <h1 th:text="${category}">category</h1>
    <p th:text="${message}" class="info-message">message</p>
    <table>
        <thead>
        <tr>
            <td>Photo</td>
            <td>RÃ©ference</td>
            <td>Description</td>
            <td>Prix</td>
            <td>Stock</td>
            <td>Commande</td>
        </tr>
        </thead>
        <tbody>
                <input id="products-form-category" type="hidden" value="test" th:value="${category}"/>
                <tr th:each="p, itemStat : ${products}">
                    <input id="products-form-count" type="hidden" th:value="${itemStat.count}"/>
                    <td><img th:src="@{'/api/file/' + ${p.image.name}}"></td>
                    <td th:text="${p.reference}">reference</td>
                    <td th:text="${p.description}">description</td>
                    <td th:text="${p.price}">price</td>
                    <td th:text="${p.stock}">stock</td>
                    <td>
                        <button th:attr="id='increment-count'+${itemStat.index}" th:onclick="'handleIncrement('+${itemStat.index}+')'">+</button>
                        <input th:attr="id='products-form-quantity'+${itemStat.index}" type="text" value="0"/>
                        <button th:attr="id='decrement-count'+${itemStat.index}" th:onclick="'handleDecrement('+${itemStat.index}+')'">-</button>
                    </td>
                </tr>
                <button onclick={processForm()}>Commander</button>

            <script>
                const handleIncrement = (i) => {
                    const q = document.getElementById('products-form-quantity' + i);
                    q.value++;
                }

                const handleDecrement = (i) => {
                    const q = document.getElementById('products-form-quantity' + i);
                    if (q.value > 0) q.value--;
                }

                function processForm() {
                    const categoryName = document.getElementById('products-form-category').value;
                    const count = document.getElementById('products-form-count').value;

                    let quantity = [];
                    for(let i = 0; i < count; i++) {
                        quantity[i] = document.getElementById("products-form-quantity" + i).value
                    }

                    fetch('http://localhost:8080/products/p', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({categoryName, quantity})
                    }).then(res => res.ok).then(res => console.log(res))

                    return false;
                }
            </script>
        </tbody>
    </table>
</body>
</html>